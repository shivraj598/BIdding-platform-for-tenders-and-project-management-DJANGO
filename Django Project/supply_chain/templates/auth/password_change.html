{% extends 'base.html' %}
{% load static %}

{% block title %}Leeds Supply Chain | Change Password{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-slate-50">
    {% if user.user_type == 'council' %}
        {% include 'includes/council_sidebar.html' %}
    {% elif user.user_type == 'contractor' %}
        {% include 'includes/contractor_sidebar.html' %}
    {% endif %}

    <div class="flex-1 py-12 px-4">
    <div class="max-w-md mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-dark-green rounded-2xl mb-4">
                <i data-lucide="lock" class="w-8 h-8 text-white"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-dark-green">Change Password</h2>
            <p class="mt-2 text-slate-600">Update your account password for enhanced security</p>
        </div>

        <!-- Password Change Form -->
        <div class="bg-white py-8 px-6 shadow-xl rounded-2xl border border-slate-100">
            <form method="POST" class="space-y-6">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span class="font-medium">Please correct the following:</span>
                        </div>
                        {% for error in form.non_field_errors %}
                            <p class="text-sm">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Current Password -->
                <div>
                    <label for="{{ form.old_password.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">
                        Current Password *
                    </label>
                    <div class="relative">
                        <input type="password" id="{{ form.old_password.id_for_label }}" name="old_password" required 
                               class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-dark-green focus:border-dark-green outline-none transition"
                               placeholder="Enter your current password">
                        <i data-lucide="lock" class="absolute right-3 top-3 w-5 h-5 text-slate-400"></i>
                    </div>
                    {% if form.old_password.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ form.old_password.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- New Password -->
                <div>
                    <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">
                        New Password *
                    </label>
                    <div class="relative">
                        <input type="password" id="{{ form.new_password1.id_for_label }}" name="new_password1" required 
                               class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-dark-green focus:border-dark-green outline-none transition"
                               placeholder="Enter your new password">
                        <i data-lucide="key" class="absolute right-3 top-3 w-5 h-5 text-slate-400"></i>
                    </div>
                    {% if form.new_password1.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ form.new_password1.errors.0 }}</p>
                    {% endif %}
                    
                    <!-- Password Requirements -->
                    <div class="mt-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <p class="text-xs font-medium text-slate-700 mb-2">Password requirements:</p>
                        <ul class="text-xs text-slate-600 space-y-1">
                            <li class="flex items-center gap-1">
                                <i data-lucide="{% if password_requirements.min_length %}check-circle{% else %}circle{% endif %}" 
                                   class="w-3 h-3 {% if password_requirements.min_length %}text-emerald-600{% else %}text-slate-400{% endif %}"></i>
                                <span>At least 8 characters</span>
                            </li>
                            <li class="flex items-center gap-1">
                                <i data-lucide="{% if password_requirements.has_uppercase %}check-circle{% else %}circle{% endif %}" 
                                   class="w-3 h-3 {% if password_requirements.has_uppercase %}text-emerald-600{% else %}text-slate-400{% endif %}"></i>
                                <span>Contains uppercase letter</span>
                            </li>
                            <li class="flex items-center gap-1">
                                <i data-lucide="{% if password_requirements.has_lowercase %}check-circle{% else %}circle{% endif %}" 
                                   class="w-3 h-3 {% if password_requirements.has_lowercase %}text-emerald-600{% else %}text-slate-400{% endif %}"></i>
                                <span>Contains lowercase letter</span>
                            </li>
                            <li class="flex items-center gap-1">
                                <i data-lucide="{% if password_requirements.has_number %}check-circle{% else %}circle{% endif %}" 
                                   class="w-3 h-3 {% if password_requirements.has_number %}text-emerald-600{% else %}text-slate-400{% endif %}"></i>
                                <span>Contains number</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Confirm New Password -->
                <div>
                    <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-1">
                        Confirm New Password *
                    </label>
                    <div class="relative">
                        <input type="password" id="{{ form.new_password2.id_for_label }}" name="new_password2" required 
                               class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-dark-green focus:border-dark-green outline-none transition"
                               placeholder="Confirm your new password">
                        <i data-lucide="key" class="absolute right-3 top-3 w-5 h-5 text-slate-400"></i>
                    </div>
                    {% if form.new_password2.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ form.new_password2.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Password Strength Meter -->
                <div id="password-strength" class="hidden">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-medium text-slate-700">Password strength:</span>
                        <span id="strength-text" class="text-xs font-medium"></span>
                    </div>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div id="strength-bar" class="h-full transition-all duration-300"></div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="pt-6 border-t border-slate-100">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <a href="{% url 'profile' %}" 
                           class="px-6 py-3 border border-slate-300 text-slate-700 rounded-xl font-medium hover:bg-slate-50 transition text-center">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="flex-1 bg-dark-green text-white px-6 py-3 rounded-xl font-bold hover-bg-green shadow-lg transition-all flex items-center gap-2 justify-center">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            Update Password
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Security Tips -->
            <div class="mt-8 pt-8 border-t border-slate-100">
                <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i data-lucide="shield" class="w-4 h-4 text-dark-green"></i>
                    Security Tips
                </h4>
                <ul class="text-sm text-slate-600 space-y-2">
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600 mt-0.5 flex-shrink-0"></i>
                        <span>Use a unique password that you don't use elsewhere</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600 mt-0.5 flex-shrink-0"></i>
                        <span>Consider using a password manager to generate and store secure passwords</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600 mt-0.5 flex-shrink-0"></i>
                        <span>Enable two-factor authentication for additional security</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600 mt-0.5 flex-shrink-0"></i>
                        <span>Change your password regularly, especially if you suspect any security issues</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </div>
</div>

<script>
    // Password strength checker
    document.addEventListener('DOMContentLoaded', function() {
        const newPasswordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
        const strengthMeter = document.getElementById('password-strength');
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        
        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                
                // Check password strength
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                // Update strength meter
                if (password.length > 0) {
                    strengthMeter.classList.remove('hidden');
                    
                    let width = '0%';
                    let color = 'bg-red-500';
                    let text = 'Very Weak';
                    
                    if (strength === 1) {
                        width = '20%';
                        color = 'bg-red-500';
                        text = 'Weak';
                    } else if (strength === 2) {
                        width = '40%';
                        color = 'bg-orange-500';
                        text = 'Fair';
                    } else if (strength === 3) {
                        width = '60%';
                        color = 'bg-yellow-500';
                        text = 'Good';
                    } else if (strength === 4) {
                        width = '80%';
                        color = 'bg-emerald-500';
                        text = 'Strong';
                    } else if (strength >= 5) {
                        width = '100%';
                        color = 'bg-emerald-600';
                        text = 'Very Strong';
                    }
                    
                    strengthBar.className = `h-full transition-all duration-300 ${color}`;
                    strengthBar.style.width = width;
                    strengthText.textContent = text;
                    strengthText.className = `text-xs font-medium ${
                        strength >= 4 ? 'text-emerald-600' : 
                        strength >= 3 ? 'text-yellow-600' : 
                        strength >= 2 ? 'text-orange-600' : 'text-red-600'
                    }`;
                } else {
                    strengthMeter.classList.add('hidden');
                }
                
                // Update requirements checkmarks
                updateRequirementsCheckmarks(password);
            });
        }
        
        function updateRequirementsCheckmarks(password) {
            const requirements = {
                min_length: password.length >= 8,
                has_uppercase: /[A-Z]/.test(password),
                has_lowercase: /[a-z]/.test(password),
                has_number: /[0-9]/.test(password),
            };
            
            // Update checkmarks
            Object.keys(requirements).forEach(key => {
                const icon = document.querySelector(`[data-requirement="${key}"] i`);
                if (icon) {
                    icon.setAttribute('data-lucide', requirements[key] ? 'check-circle' : 'circle');
                    icon.className = `w-3 h-3 ${requirements[key] ? 'text-emerald-600' : 'text-slate-400'}`;
                    lucide.createIcons();
                }
            });
        }
        
        // Auto-focus current password field
        const currentPasswordInput = document.getElementById('{{ form.old_password.id_for_label }}');
        if (currentPasswordInput) {
            currentPasswordInput.focus();
        }
        
        // Form validation
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const newPassword1 = document.getElementById('{{ form.new_password1.id_for_label }}');
                const newPassword2 = document.getElementById('{{ form.new_password2.id_for_label }}');
                
                if (newPassword1 && newPassword2 && newPassword1.value !== newPassword2.value) {
                    e.preventDefault();
                    alert('New passwords do not match. Please make sure both fields contain the same password.');
                    newPassword2.focus();
                }
            });
        }
    });
</script>
{% endblock %}