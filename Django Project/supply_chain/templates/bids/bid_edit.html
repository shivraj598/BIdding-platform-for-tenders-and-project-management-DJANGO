{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Bid | Leeds Supply Chain{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-slate-50">
    <!-- Sidebar -->
    {% include 'includes/contractor_sidebar.html' %}
    
    <!-- Main Content -->
    <div class="flex-1">
    <div class="py-8">
        <div class="max-w-4xl mx-auto px-4">
            <!-- Breadcrumb -->
            <nav class="flex items-center gap-2 text-sm text-slate-500 mb-8">
                <a href="{% url 'home' %}" class="hover:text-dark-green">Home</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <a href="{% url 'contractor_dashboard' %}" class="hover:text-dark-green">Dashboard</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <a href="{% url 'my_bids' %}" class="hover:text-dark-green">My Bids</a>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <span class="text-dark-green font-medium">Edit Bid</span>
            </nav>
            
            <!-- Form Header -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 mb-8 overflow-hidden">
                <div class="bg-dark-green text-white p-8">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-white/20 p-3 rounded-xl">
                            <i data-lucide="edit" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Edit Your Bid</h1>
                            <p class="text-emerald-200 mt-1">Update your bid for "{{ bid.package.title }}"</p>
                        </div>
                    </div>
                </div>
                
                <!-- Bid Status & Package Info Card -->
                <div class="p-6 border-b border-slate-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="font-bold text-slate-800">{{ bid.package.title }}</h3>
                            <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mt-1">
                                <span class="flex items-center gap-1">
                                    <i data-lucide="package" class="w-4 h-4"></i>
                                    {{ bid.package.get_package_type_display }}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    Deadline: {{ bid.package.deadline|date:"M d, Y" }}
                                </span>
                                {% if bid.package.estimated_cost %}
                                <span class="flex items-center gap-1">
                                    <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                    Estimated: ${{ bid.package.estimated_cost }}
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-slate-600 mt-2">{{ bid.package.description|truncatechars:150 }}</p>
                        </div>
                        <a href="{% url 'package_detail' bid.package.id %}" 
                           class="text-dark-green hover:underline font-medium flex items-center gap-1">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            Back to Package
                        </a>
                    </div>
                    
                    <!-- Bid Status Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6 border-t border-slate-100">
                        <div>
                            <p class="text-xs font-medium text-slate-500 mb-1">Current Status</p>
                            <span class="inline-block text-sm font-medium px-3 py-1 rounded-full 
                                {% if bid.status == 'draft' %}bg-gray-100 text-gray-800
                                {% elif bid.status == 'submitted' %}bg-blue-100 text-blue-800
                                {% elif bid.status == 'under_review' %}bg-amber-100 text-amber-800
                                {% elif bid.status == 'accepted' %}bg-emerald-100 text-emerald-800
                                {% elif bid.status == 'rejected' %}bg-red-100 text-red-800
                                {% else %}bg-slate-100 text-slate-800{% endif %}">
                                {{ bid.get_status_display }}
                            </span>
                        </div>
                        <div>
                            <p class="text-xs font-medium text-slate-500 mb-1">Submitted Date</p>
                            <p class="text-sm font-medium text-slate-800">{{ bid.submitted_at|date:"M d, Y" }}</p>
                        </div>
                        <div>
                            <p class="text-xs font-medium text-slate-500 mb-1">Last Modified</p>
                            <p class="text-sm font-medium text-slate-800">{{ bid.updated_at|date:"M d, Y" }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status Warning -->
            {% if bid.status != 'draft' and bid.status != 'submitted' %}
            <div class="mb-8 bg-amber-50 border border-amber-200 text-amber-800 px-6 py-4 rounded-xl">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mt-0.5"></i>
                    <div>
                        <p class="font-medium">Limited Editing Available</p>
                        <p class="text-sm mt-1">Your bid is currently under review or has been reviewed. You can only edit certain fields. Contact the council if you need to make significant changes.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Bid Form -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                <form method="POST" enctype="multipart/form-data" class="space-y-8">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                <span class="font-medium">Please correct the errors below:</span>
                            </div>
                            <ul class="list-disc list-inside text-sm">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    <!-- Bid Amount & Duration -->
                    <div class="space-y-6">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-dark-green"></i>
                            Bid Details
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Bid Amount -->
                            <div>
                                <label for="{{ form.bid_amount.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-2">
                                    Bid Amount ($) *
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-500">$</span>
                                    <input type="number" id="{{ form.bid_amount.id_for_label }}" name="bid_amount" 
                                           value="{{ form.bid_amount.value|default:'' }}" required min="0" step="0.01"
                                           class="w-full pl-8 pr-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-dark-green focus:border-dark-green outline-none transition"
                                           placeholder="0.00">
                                </div>
                                {% if form.bid_amount.errors %}
                                    <div class="mt-2 text-sm text-red-600 flex items-center gap-1">
                                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                        {{ form.bid_amount.errors.0 }}
                                    </div>
                                {% endif %}
                                <p class="mt-2 text-sm text-slate-500">
                                    {% if bid.package.estimated_cost %}
                                        Package estimate: ${{ bid.package.estimated_cost }}
                                    {% else %}
                                        No estimate provided by council
                                    {% endif %}
                                </p>
                            </div>
                            
                            <!-- Duration -->
                            <div>
                                <label for="{{ form.duration_days.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-2">
                                    Estimated Duration (Days) *
                                </label>
                                <div class="relative">
                                    <input type="number" id="{{ form.duration_days.id_for_label }}" name="duration_days" 
                                           value="{{ form.duration_days.value|default:'' }}" required min="1"
                                           class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-dark-green focus:border-dark-green outline-none transition"
                                           placeholder="e.g., 30">
                                    <span class="absolute right-3 top-3 text-slate-500">days</span>
                                </div>
                                {% if form.duration_days.errors %}
                                    <div class="mt-2 text-sm text-red-600 flex items-center gap-1">
                                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                        {{ form.duration_days.errors.0 }}
                                    </div>
                                {% endif %}
                                <p class="mt-2 text-sm text-slate-500">Enter estimated completion time in calendar days</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Proposal Text -->
                    <div class="space-y-6 pt-8 border-t border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-5 h-5 text-dark-green"></i>
                            Proposal Details
                        </h2>
                        
                        <div>
                            <label for="{{ form.proposal_text.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-2">
                                Proposal Text *
                            </label>
                            <textarea id="{{ form.proposal_text.id_for_label }}" name="proposal_text" rows="8" required
                                      class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-dark-green focus:border-dark-green outline-none transition"
                                      placeholder="Describe your approach, methodology, team composition, previous experience with similar projects, quality assurance measures, safety protocols, and any other relevant information...">{{ form.proposal_text.value|default:'' }}</textarea>
                            {% if form.proposal_text.errors %}
                                <div class="mt-2 text-sm text-red-600 flex items-center gap-1">
                                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                    {{ form.proposal_text.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600">
                                <div>
                                    <p class="font-medium text-slate-700 mb-1">Recommended to include:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Project approach & methodology</li>
                                        <li>Team composition & experience</li>
                                        <li>Timeline breakdown</li>
                                        <li>Quality assurance measures</li>
                                    </ul>
                                </div>
                                <div>
                                    <p class="font-medium text-slate-700 mb-1">Additional information:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Safety protocols</li>
                                        <li>Risk management plan</li>
                                        <li>Resource allocation</li>
                                        <li>Previous similar projects</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Document Upload -->
                    <div class="space-y-6 pt-8 border-t border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="upload-cloud" class="w-5 h-5 text-dark-green"></i>
                            Supporting Documents
                        </h2>
                        
                        <div>
                            <label for="{{ form.proposal_document.id_for_label }}" class="block text-sm font-medium text-slate-700 mb-2">
                                Proposal Document (Optional)
                            </label>
                            
                            {% if bid.proposal_document %}
                            <div class="mb-4 p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                                <p class="text-sm font-medium text-emerald-800 mb-2">Current Document:</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="file-pdf" class="w-5 h-5 text-red-600"></i>
                                        <span class="text-sm text-emerald-700">{{ bid.proposal_document.name|cut:"proposals/" }}</span>
                                    </div>
                                    <a href="{{ bid.proposal_document.url }}" target="_blank" class="text-sm text-emerald-600 hover:underline">
                                        Download
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center cursor-pointer hover:bg-slate-50 transition"
                                 onclick="document.getElementById('proposal_document').click()">
                                <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-slate-400 mb-3"></i>
                                <p class="text-slate-600 mb-1">Click to upload or replace document</p>
                                <p class="text-sm text-slate-500">PDF, DOC, DOCX files up to 10MB</p>
                            </div>
                            <input type="file" id="proposal_document" name="proposal_document" 
                                   accept=".pdf,.doc,.docx"
                                   class="hidden" onchange="updateFileName('proposal_document', 'document-file-name')">
                            <p id="document-file-name" class="text-sm text-slate-500 mt-2"></p>
                            {% if form.proposal_document.errors %}
                                <div class="mt-2 text-sm text-red-600 flex items-center gap-1">
                                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                    {{ form.proposal_document.errors.0 }}
                                </div>
                            {% endif %}
                            
                            <div class="mt-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <div class="flex items-start gap-3">
                                    <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium mb-1">Document Suggestions</p>
                                        <p>Consider including detailed project plans, company profile, certifications, insurance documents, financial statements, or detailed technical specifications.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Terms and Conditions -->
                    <div class="space-y-6 pt-8 border-t border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="shield-check" class="w-5 h-5 text-dark-green"></i>
                            Terms & Conditions
                        </h2>
                        
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <div class="space-y-4">
                                <label class="flex items-start gap-3">
                                    <input type="checkbox" required 
                                           class="mt-1 rounded border-slate-300 text-dark-green focus:ring-dark-green">
                                    <span class="text-sm text-slate-700">
                                        I confirm that all information provided in this bid is accurate and complete to the best of my knowledge.
                                    </span>
                                </label>
                                
                                <label class="flex items-start gap-3">
                                    <input type="checkbox" required 
                                           class="mt-1 rounded border-slate-300 text-dark-green focus:ring-dark-green">
                                    <span class="text-sm text-slate-700">
                                        I understand that this bid constitutes a binding offer and can only be withdrawn before the bidding deadline.
                                    </span>
                                </label>
                                
                                <label class="flex items-start gap-3">
                                    <input type="checkbox" required 
                                           class="mt-1 rounded border-slate-300 text-dark-green focus:ring-dark-green">
                                    <span class="text-sm text-slate-700">
                                        I agree to comply with all project requirements, specifications, and timelines if my bid is accepted.
                                    </span>
                                </label>
                                
                                <div class="mt-4 text-xs text-slate-500">
                                    <p>By updating this bid, you agree to the <a href="#" class="text-dark-green hover:underline">Leeds Supply Chain Terms of Service</a> and <a href="#" class="text-dark-green hover:underline">Bidding Guidelines</a>.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="pt-8 border-t border-slate-100 flex flex-col sm:flex-row gap-4 justify-end">
                        <a href="{% url 'my_bids' %}" 
                           class="px-6 py-3 border border-slate-300 text-slate-700 rounded-xl font-medium hover:bg-slate-50 transition text-center">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="bg-dark-green text-white px-8 py-3 rounded-xl font-bold hover-bg-green shadow-lg transition-all flex items-center gap-2 justify-center">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            Update Bid
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Bid History -->
            {% if bid.status != 'draft' %}
            <div class="mt-8 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5 text-dark-green"></i>
                    Bid History
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-start gap-4 pb-4 border-b border-slate-100">
                        <div class="flex-shrink-0">
                            <div class="flex items-center justify-center h-8 w-8 rounded-full bg-dark-green text-white">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-800">Bid Submitted</p>
                            <p class="text-sm text-slate-600">{{ bid.submitted_at|date:"M d, Y \a\t H:i" }}</p>
                        </div>
                    </div>
                    
                    {% if bid.reviewed_at %}
                    <div class="flex items-start gap-4 pb-4 border-b border-slate-100">
                        <div class="flex-shrink-0">
                            <div class="flex items-center justify-center h-8 w-8 rounded-full {% if bid.status == 'accepted' %}bg-emerald-600{% else %}bg-red-600{% endif %} text-white">
                                {% if bid.status == 'accepted' %}
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                {% else %}
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-800">
                                {% if bid.status == 'accepted' %}
                                    Bid Accepted
                                {% elif bid.status == 'rejected' %}
                                    Bid Rejected
                                {% else %}
                                    Bid Reviewed
                                {% endif %}
                            </p>
                            <p class="text-sm text-slate-600">{{ bid.reviewed_at|date:"M d, Y \a\t H:i" }}</p>
                            {% if bid.review_notes %}
                            <p class="text-sm text-slate-700 mt-2 p-3 bg-slate-50 rounded border border-slate-200">
                                <span class="font-medium">Council Feedback:</span> {{ bid.review_notes }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    </div>
</div>

<script>
    // File upload handling
    function updateFileName(inputId, displayId) {
        const input = document.getElementById(inputId);
        const display = document.getElementById(displayId);
        if (input.files.length > 0) {
            const file = input.files[0];
            const fileSize = (file.size / (1024 * 1024)).toFixed(2); // MB
            
            if (fileSize > 10) {
                alert('File size exceeds 10MB limit. Please choose a smaller file.');
                input.value = '';
                display.textContent = '';
                display.className = 'text-sm text-red-500 mt-2';
                display.textContent = 'File too large (max 10MB)';
            } else {
                display.textContent = 'Selected file: ' + file.name + ' (' + fileSize + ' MB)';
                display.className = 'text-sm text-dark-green font-medium mt-2';
            }
        }
    }
    
    // Form validation
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Check terms checkboxes
                const checkboxes = form.querySelectorAll('input[type="checkbox"][required]');
                let allChecked = true;
                
                checkboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        allChecked = false;
                        checkbox.parentElement.classList.add('text-red-600');
                    } else {
                        checkbox.parentElement.classList.remove('text-red-600');
                    }
                });
                
                if (!allChecked) {
                    e.preventDefault();
                    alert('Please agree to all terms and conditions before updating your bid.');
                    return false;
                }
                
                // Check deadline
                const deadline = new Date('{{ bid.package.deadline|date:"Y-m-d" }}');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (deadline < today) {
                    e.preventDefault();
                    alert('The bidding deadline for this package has passed. You cannot modify bids after the deadline.');
                    return false;
                }
            });
        }
        
        // Auto-focus first input
        const firstInput = document.querySelector('form input[required]');
        if (firstInput) {
            firstInput.focus();
        }
    });
</script>
{% endblock %}
